<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‚¡ç¥¨åˆ†æå¸«</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">
    <!-- Tailwind CSS CDN (ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ„å»ºç‰ˆæœ¬) -->
    <script>
        // éšè— Tailwind CDN è­¦å‘Š
        if (typeof console !== 'undefined' && console.warn) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                    return; // å¿½ç•¥ Tailwind CDN è­¦å‘Š
                }
                originalWarn.apply(console, args);
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* è‡ªå®šç¾©å‹•ç•« */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .animate-pulse-slow { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* å°ç£è‚¡å¸‚é¡è‰²ç¿’æ…£ï¼šç´…æ¼²ç¶ è·Œ */
        .stock-up { color: #ef4444; }
        .stock-down { color: #22c55e; }
        
        /* çµ±ä¸€å¡ç‰‡æ¨£å¼ */
        .card-base {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            transition: all 0.3s ease;
        }
        .card-base:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        /* çµ±ä¸€æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
        }
        
        /* æ¨™ç±¤é æ¨£å¼å„ªåŒ– */
        .style-tab-btn {
            position: relative;
            transition: all 0.2s ease;
        }
        .style-tab-btn:hover {
            background: rgba(51, 65, 85, 0.3);
        }
        
        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(51, 65, 85, 0.8);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(71, 85, 105, 0.9);
        }
        
        /* è¼¸å…¥æ¡†èšç„¦æ•ˆæœ */
        input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* æ¼¸è®ŠèƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen flex flex-col items-center p-4 md:p-8">

    <div id="key-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 p-8 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-400 text-3xl">
                    <i class="fa-solid fa-key"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">å•Ÿå‹• AI åˆ†æå¸«</h2>
                <p class="text-slate-400 text-sm mt-2">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key</p>
            </div>
            <input type="password" id="api-key-input" class="w-full bg-slate-900 border border-slate-600 p-4 rounded-xl mb-4 text-white focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="è²¼ä¸Š API Key (AIzaSy...)">
            <button onclick="saveKey()" class="w-full bg-blue-600 hover:bg-blue-500 text-white p-4 rounded-xl font-bold transition shadow-lg shadow-blue-500/30">
                é–‹å§‹é€£ç·š
            </button>
            <p class="text-center mt-4 text-xs text-slate-500">Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œå®‰å…¨ç„¡è™ã€‚</p>
        </div>
    </div>

    <header class="w-full max-w-6xl flex justify-between items-center mb-6 pb-4 border-b border-slate-700/50">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-robot text-lg"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">AI è‚¡ç¥¨åˆ†æå¸«</h1>
                <p class="text-xs text-slate-400 mt-0.5">ç”± FinMind å’Œ Google Gemini æä¾›å°ˆæ¥­åˆ†æ</p>
            </div>
        </div>
        <button onclick="showModal()" class="text-slate-400 hover:text-white transition-all text-sm px-4 py-2 rounded-lg hover:bg-slate-800/50 flex items-center gap-2">
            <i class="fa-solid fa-gear"></i> 
            <span class="hidden sm:inline">è¨­å®š Key</span>
        </button>
    </header>

    <main class="w-full max-w-6xl flex-1 flex flex-col gap-6">
        
        <!-- æœå°‹å€åŸŸ -->
        <div class="card-base p-3 rounded-2xl flex flex-col md:flex-row gap-3 shadow-xl">
            <div class="flex-1 relative">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400 z-10"></i>
                <input id="ticker-input" type="text" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæˆ–åç¨± (å¦‚ 2330ã€å°ç©é›»ã€3481)" 
                    class="w-full bg-slate-900/60 border border-slate-700/50 rounded-xl pl-12 pr-4 py-3.5 text-white placeholder-slate-500 focus:bg-slate-900 focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all font-medium"
                    onkeypress="if(event.key==='Enter') analyzeStock()">
            </div>
            
            <div class="bg-slate-900/40 text-slate-300 px-5 py-3.5 rounded-xl border border-slate-700/50 flex items-center gap-2.5 text-sm font-medium">
                <i class="fa-solid fa-chart-line text-blue-400"></i>
                <span class="hidden sm:inline">å…¨é¢¨æ ¼åˆ†æ</span>
                <span class="sm:hidden">å…¨åˆ†æ</span>
            </div>
            
            <button onclick="saveCurrentStock()" id="save-btn" 
                class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white px-5 py-3.5 rounded-xl font-semibold transition-all shadow-lg shadow-green-600/20 whitespace-nowrap flex items-center justify-center gap-2 hover:scale-105" 
                title="å„²å­˜ç•¶å‰è‚¡ç¥¨">
                <i class="fa-solid fa-bookmark"></i>
                <span class="hidden sm:inline">å„²å­˜</span>
            </button>
            
            <button onclick="openLowPriceFilter()" id="filter-btn" 
                class="bg-gradient-to-r from-orange-600 to-amber-500 hover:from-orange-500 hover:to-amber-400 text-white px-5 py-3.5 rounded-xl font-semibold transition-all shadow-lg shadow-orange-600/20 whitespace-nowrap flex items-center justify-center gap-2 hover:scale-105" 
                title="ç¯©é¸ä½åƒ¹è‚¡">
                <i class="fa-solid fa-filter"></i>
                <span class="hidden sm:inline">ä½åƒ¹è‚¡</span>
            </button>
            
            <button onclick="analyzeStock()" id="analyze-btn" 
                class="btn-primary text-white px-6 py-3.5 rounded-xl font-bold shadow-lg shadow-blue-600/30 whitespace-nowrap flex items-center justify-center gap-2">
                <span>AI åˆ†æ</span> 
                <i class="fa-solid fa-wand-magic-sparkles"></i>
            </button>
        </div>

        <!-- å·²ä¿å­˜çš„è‚¡ç¥¨åˆ—è¡¨ -->
        <div id="saved-stocks-container" class="card-base rounded-2xl p-5 shadow-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold text-slate-200 flex items-center gap-2.5">
                    <i class="fa-solid fa-star text-yellow-400"></i>
                    <span>å·²ä¿å­˜çš„è‚¡ç¥¨</span>
                </h3>
                <button onclick="clearAllSavedStocks()" class="text-xs text-slate-400 hover:text-red-400 transition-all px-2 py-1 rounded hover:bg-red-500/10 flex items-center gap-1.5">
                    <i class="fa-solid fa-trash text-xs"></i> 
                    <span class="hidden sm:inline">æ¸…é™¤å…¨éƒ¨</span>
                </button>
            </div>
            <div id="saved-stocks-list" class="flex flex-wrap gap-2.5">
                <!-- å·²ä¿å­˜çš„è‚¡ç¥¨æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
            <p id="no-saved-stocks" class="text-xs text-slate-500 text-center py-3 hidden">å°šæœªä¿å­˜ä»»ä½•è‚¡ç¥¨</p>
        </div>

        <div id="loading" class="hidden py-20 text-center">
            <div class="inline-block w-16 h-16 border-4 border-slate-700 border-t-blue-500 rounded-full animate-spin mb-4"></div>
            <p class="text-slate-400 animate-pulse">æ­£åœ¨ç²å–è‚¡ç¥¨æ•¸æ“šèˆ‡æŠ€è¡“æŒ‡æ¨™...</p>
            <p class="text-slate-500 text-sm mt-1">AI æ­£åœ¨é€²è¡Œå°ˆæ¥­åˆ†æ</p>
        </div>

        <div id="result-area" class="hidden flex flex-col gap-6">
            
            <!-- ä¸»è¦è‚¡ç¥¨ä¿¡æ¯å¡ç‰‡ -->
            <div class="card-base rounded-2xl p-6 md:p-8 flex flex-col md:flex-row justify-between items-start md:items-center relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-full blur-3xl -mr-32 -mt-32"></div>
                <div class="z-10 flex-1">
                    <h2 id="stock-name" class="text-3xl md:text-4xl font-bold text-white mb-3 tracking-tight">--</h2>
                    <div class="flex items-center gap-3 flex-wrap">
                        <span class="bg-blue-500/20 text-blue-300 px-3 py-1.5 rounded-lg text-xs font-semibold border border-blue-500/30 backdrop-blur-sm">å³æ™‚è¡Œæƒ…</span>
                        <span id="stock-pe" class="flex items-center gap-1.5 text-sm text-slate-300">
                            <i class="fa-solid fa-chart-pie text-xs text-blue-400"></i>
                            <span>æœ¬ç›Šæ¯”: --</span>
                        </span>
                        </div>
                    </div>
                <div class="text-right z-10 mt-4 md:mt-0">
                    <div id="stock-price" class="text-4xl md:text-6xl font-mono font-bold text-white tracking-tighter mb-2">--</div>
                    <div id="stock-change" class="text-xl md:text-2xl font-bold flex items-center justify-end gap-2">
                            <span>--%</span>
                        </div>
                    </div>
                </div>

            <!-- è²¡å‹™æŒ‡æ¨™å¡ç‰‡ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="card-base p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center backdrop-blur-sm border border-blue-500/30">
                            <i class="fa-solid fa-chart-pie text-blue-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1 font-medium">æœ¬ç›Šæ¯”</p>
                            <p id="metric-pe" class="text-xl font-bold text-white">--</p>
                    </div>
                </div>
            </div>

                <div class="card-base p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center backdrop-blur-sm border border-green-500/30">
                            <i class="fa-solid fa-coins text-green-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1 font-medium">è‚¡æ¯ç‡</p>
                            <p id="metric-dividend" class="text-xl font-bold text-white">--</p>
                        </div>
                    </div>
                </div>
                
                <div class="card-base p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center backdrop-blur-sm border border-purple-500/30">
                            <i class="fa-solid fa-building text-purple-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1 font-medium">è‚¡åƒ¹æ·¨å€¼æ¯”</p>
                            <p id="metric-pb" class="text-xl font-bold text-white">--</p>
                        </div>
                    </div>
                </div>

                <div class="card-base p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center backdrop-blur-sm border border-yellow-500/30">
                            <i class="fa-solid fa-chart-bar text-yellow-400 text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-slate-400 mb-1 font-medium">æˆäº¤é‡</p>
                            <p id="metric-volume" class="text-xl font-bold text-white">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åƒ¹æ ¼å€é–“å¡ç‰‡ -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="card-base p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-2 font-medium">å‰æ”¶ç›¤</p>
                    <p id="metric-prev-close" class="text-lg font-bold text-slate-200">--</p>
                </div>
                <div class="card-base p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-2 font-medium">ä»Šæ—¥æœ€é«˜</p>
                    <p id="metric-high" class="text-lg font-bold text-red-400">--</p>
                </div>
                <div class="card-base p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-2 font-medium">ä»Šæ—¥æœ€ä½</p>
                    <p id="metric-low" class="text-lg font-bold text-green-400">--</p>
                </div>
                <div class="card-base p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-2 font-medium">52é€±æœ€é«˜</p>
                    <p id="metric-52w-high" class="text-lg font-bold text-red-300">--</p>
                </div>
                <div class="card-base p-4 rounded-xl">
                    <p class="text-xs text-slate-400 mb-2 font-medium">52é€±æœ€ä½</p>
                    <p id="metric-52w-low" class="text-lg font-bold text-green-300">--</p>
                </div>
            </div>

            <!-- ç±Œç¢¼é¢æ•¸æ“š -->
            <div id="chip-data-section" class="card-base rounded-2xl overflow-hidden animate-fade-in hidden">
                <div class="p-6 border-b border-slate-700/50 bg-gradient-to-r from-orange-900/20 to-transparent">
                    <h3 class="text-orange-400 font-bold text-lg mb-4 flex items-center gap-2.5">
                        <i class="fa-solid fa-users"></i> 
                        <span>ç±Œç¢¼é¢åˆ†æ</span>
                    </h3>
                    
                    <!-- ä¸‰å¤§æ³•äºº -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-globe text-blue-400"></i>
                                <span class="text-slate-300 font-medium">å¤–è³‡</span>
                            </div>
                            <p id="chip-foreign-today" class="text-xl font-bold text-white">--</p>
                            <p id="chip-foreign-total" class="text-xs text-slate-400 mt-1">è¿‘10æ—¥ç´¯è¨ˆ: --</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-building-columns text-green-400"></i>
                                <span class="text-slate-300 font-medium">æŠ•ä¿¡</span>
                            </div>
                            <p id="chip-trust-today" class="text-xl font-bold text-white">--</p>
                            <p id="chip-trust-total" class="text-xs text-slate-400 mt-1">è¿‘10æ—¥ç´¯è¨ˆ: --</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-landmark text-purple-400"></i>
                                <span class="text-slate-300 font-medium">è‡ªç‡Ÿå•†</span>
                            </div>
                            <p id="chip-dealer-today" class="text-xl font-bold text-white">--</p>
                            <p id="chip-dealer-total" class="text-xs text-slate-400 mt-1">è¿‘10æ—¥ç´¯è¨ˆ: --</p>
                        </div>
                    </div>
                    
                    <!-- èè³‡èåˆ¸ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">èè³‡é¤˜é¡</p>
                            <p id="chip-margin-balance" class="text-lg font-bold text-red-400">--</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">èè³‡å¢æ¸›</p>
                            <p id="chip-margin-change" class="text-lg font-bold text-white">--</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">èåˆ¸é¤˜é¡</p>
                            <p id="chip-short-balance" class="text-lg font-bold text-green-400">--</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">åˆ¸è³‡æ¯”</p>
                            <p id="chip-ratio" class="text-lg font-bold text-yellow-400">--</p>
                        </div>
                    </div>
                </div>
                
                <!-- æœˆç‡Ÿæ”¶ -->
                <div class="p-6 bg-gradient-to-r from-emerald-900/20 to-transparent">
                    <h3 class="text-emerald-400 font-bold text-lg mb-4 flex items-center gap-2.5">
                        <i class="fa-solid fa-chart-line"></i> 
                        <span>æœˆç‡Ÿæ”¶</span>
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">æœ€æ–°ç‡Ÿæ”¶</p>
                            <p id="revenue-latest" class="text-lg font-bold text-white">--</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">å¹´å¢ç‡ (YoY)</p>
                            <p id="revenue-yoy" class="text-lg font-bold text-white">--</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">è¿‘3æœˆå¹³å‡</p>
                            <p id="revenue-avg3m" class="text-lg font-bold text-white">--</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                            <p class="text-xs text-slate-400 mb-1">æˆé•·è¶¨å‹¢</p>
                            <p id="revenue-trend" class="text-lg font-bold text-white">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ€è¡“ç·šåœ–å’Œäº¤æ˜“é‡åœ–è¡¨ -->
            <div class="card-base rounded-2xl overflow-hidden animate-fade-in">
                <div class="p-6 border-b border-slate-700/50 bg-gradient-to-r from-slate-800/50 to-transparent">
                    <h3 class="text-blue-400 font-bold text-lg mb-4 flex items-center gap-2.5">
                        <i class="fa-solid fa-chart-line"></i> 
                        <span>æŠ€è¡“ç·šåœ–</span>
                    </h3>
                    <div class="relative h-72 bg-slate-900/30 rounded-lg p-2">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="p-6 bg-gradient-to-r from-slate-800/50 to-transparent">
                    <h3 class="text-blue-400 font-bold text-lg mb-4 flex items-center gap-2.5">
                        <i class="fa-solid fa-chart-bar"></i> 
                        <span>æ¯æ—¥äº¤æ˜“é‡</span>
                    </h3>
                    <div class="relative h-56 bg-slate-900/30 rounded-lg p-2">
                        <canvas id="volume-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- å¤šé¢¨æ ¼åˆ†æçµæœï¼ˆæ¨™ç±¤é åˆ‡æ›ï¼‰ -->
            <div class="card-base rounded-2xl overflow-hidden">
                <!-- æ¨™ç±¤æŒ‰éˆ•å’Œå°å‡ºæŒ‰éˆ• -->
                <div class="flex items-center justify-between border-b border-slate-700/50 bg-gradient-to-r from-slate-800/80 to-slate-800/50">
                    <div class="flex flex-1 overflow-x-auto">
                    <button onclick="switchStyleTab(0)" id="style-tab-0" class="style-tab-btn flex-1 px-5 py-4 text-sm font-bold transition-all border-b-2 border-blue-400 text-blue-400 bg-slate-800/30 min-w-[140px]">
                        <span class="text-lg mr-2">ğŸ’</span> åƒ¹å€¼æŠ•è³‡
                    </button>
                    <button onclick="switchStyleTab(1)" id="style-tab-1" class="style-tab-btn flex-1 px-5 py-4 text-sm font-bold transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-200 min-w-[140px]">
                        <span class="text-lg mr-2">âš¡</span> çŸ­ç·šç•¶æ²–
                    </button>
                    <button onclick="switchStyleTab(2)" id="style-tab-2" class="style-tab-btn flex-1 px-5 py-4 text-sm font-bold transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-200 min-w-[140px]">
                        <span class="text-lg mr-2">ğŸš€</span> æˆé•·å‹æŠ•è³‡
                    </button>
                    <button onclick="switchStyleTab(3)" id="style-tab-3" class="style-tab-btn flex-1 px-5 py-4 text-sm font-bold transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-200 min-w-[140px]">
                        <span class="text-lg mr-2">ğŸ›¡ï¸</span> ä¿å®ˆå­˜è‚¡
                    </button>
                    </div>
                    <button onclick="exportToLineNotebook()" 
                        class="mx-4 px-4 py-2 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white rounded-lg font-semibold text-sm transition-all shadow-lg shadow-green-600/20 flex items-center gap-2 whitespace-nowrap hover:scale-105"
                        title="åŒ¯å‡ºç‚º LINE ç­†è¨˜æœ¬æ ¼å¼">
                        <i class="fa-solid fa-download"></i>
                        <span class="hidden sm:inline">åŒ¯å‡ºç­†è¨˜</span>
                    </button>
                </div>
                
                <!-- åˆ†æçµæœå…§å®¹å€åŸŸ -->
                <div id="multi-style-analysis" class="p-6 md:p-8">
                    <!-- å‹•æ…‹æ’å…¥ç•¶å‰é¸ä¸­é¢¨æ ¼çš„åˆ†æçµæœ -->
                </div>
            </div>

            <!-- å–®é¢¨æ ¼åˆ†æçµæœï¼ˆä¿ç•™ä»¥å‚™ç”¨ï¼‰ -->
            <div id="single-style-analysis" class="bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden animate-fade-in hidden">
                <div class="p-6 border-b border-slate-700 bg-slate-800/50">
                    <h3 class="text-blue-400 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-regular fa-lightbulb"></i> å¸‚å ´ç¸½çµ
                    </h3>
                    <p id="ai-summary" class="text-lg text-slate-200 leading-relaxed italic">...</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2">
                    <div class="p-6 border-r border-slate-700 border-b md:border-b-0 border-slate-700/50">
                        <h4 class="text-green-400 font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-arrow-trend-up"></i> çœ‹å¤šè¨Šè™Ÿ
                        </h4>
                        <ul id="bull-list" class="space-y-3 text-sm text-slate-300"></ul>
                    </div>
                    <div class="p-6">
                        <h4 class="text-red-400 font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-triangle-exclamation"></i> é¢¨éšªè­¦ç¤º
                        </h4>
                        <ul id="bear-list" class="space-y-3 text-sm text-slate-300"></ul>
                    </div>
                </div>

                <div class="p-6 bg-slate-900/30 border-t border-slate-700">
                    <h4 class="text-slate-400 text-xs font-bold uppercase mb-3 tracking-wider">è©³ç´°åˆ†æ</h4>
                    <p id="ai-analysis" class="text-slate-300 leading-7 text-sm text-justify">...</p>
                </div>
            </div>

            <p class="text-center text-xs text-slate-600 pb-8">
                å…è²¬è²æ˜ï¼šAI åˆ†æåƒ…ä¾›åƒè€ƒï¼Œä¸ä»£è¡¨æŠ•è³‡å»ºè­°ã€‚è‚¡å¸‚æ•¸æ“šç”± FinMind æä¾›ï¼Œå¯èƒ½æœ‰å»¶é²ã€‚
            </p>
        </div>

    </main>

    <!-- ä½åƒ¹è‚¡ç¯©é¸å½ˆçª— -->
    <div id="low-price-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden border border-slate-700 shadow-2xl">
            <!-- æ¨™é¡Œåˆ— -->
            <div class="p-5 border-b border-slate-700 bg-gradient-to-r from-orange-900/30 to-transparent flex items-center justify-between">
                <h2 class="text-xl font-bold text-orange-400 flex items-center gap-3">
                    <i class="fa-solid fa-filter"></i>
                    ä½åƒ¹è‚¡ç¯©é¸
                </h2>
                <button onclick="closeLowPriceFilter()" class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-800 rounded-lg">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- ç¯©é¸æ¢ä»¶ -->
            <div class="p-5 border-b border-slate-700 bg-slate-800/50">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-slate-300 text-sm">è‚¡åƒ¹ä½æ–¼</label>
                        <input type="number" id="filter-max-price" value="10" min="1" max="100" step="1" 
                            class="w-20 px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-center focus:border-orange-500 focus:outline-none">
                        <span class="text-slate-300 text-sm">å…ƒ</span>
                    </div>
                    <button onclick="fetchLowPriceStocks()" id="filter-search-btn"
                        class="bg-gradient-to-r from-orange-600 to-amber-500 hover:from-orange-500 hover:to-amber-400 text-white px-5 py-2 rounded-lg font-semibold transition-all flex items-center gap-2">
                        <i class="fa-solid fa-search"></i>
                        æœå°‹
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-3">
                    <i class="fa-solid fa-circle-info"></i> 
                    ç¯©é¸æ¢ä»¶ï¼šä¸Šå¸‚/ä¸Šæ«ƒè‚¡ç¥¨ã€æœ‰æˆäº¤é‡ã€éæ¬Šè­‰/ETN
                </p>
            </div>
            
            <!-- çµæœåˆ—è¡¨ -->
            <div class="p-5 overflow-y-auto max-h-[50vh]">
                <div id="filter-loading" class="hidden py-10 text-center">
                    <div class="inline-block w-10 h-10 border-3 border-slate-700 border-t-orange-500 rounded-full animate-spin mb-3"></div>
                    <p class="text-slate-400 text-sm">æ­£åœ¨ç¯©é¸è‚¡ç¥¨...</p>
                </div>
                
                <div id="filter-results" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm text-slate-400">
                            æ‰¾åˆ° <span id="filter-count" class="text-orange-400 font-bold">0</span> æ”¯ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨
                        </p>
                    </div>
                    
                    <div id="filter-stock-list" class="space-y-2">
                        <!-- è‚¡ç¥¨åˆ—è¡¨æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
                    </div>
                </div>
                
                <div id="filter-empty" class="hidden py-10 text-center">
                    <i class="fa-solid fa-face-sad-tear text-4xl text-slate-600 mb-3"></i>
                    <p class="text-slate-400">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨å¾Œç«¯ API ç²å– FinMind æ•¸æ“š
        
        // ========== å¾Œç«¯ API é…ç½® ==========
        // å¾Œç«¯ä¼ºæœå™¨æœƒè™•ç† FinMind API èª¿ç”¨ï¼Œé¿å… CORS å•é¡Œ
        const API_BASE_URL = window.location.origin;

        // ========== ä½åƒ¹è‚¡ç¯©é¸åŠŸèƒ½ ==========
        function openLowPriceFilter() {
            document.getElementById('low-price-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeLowPriceFilter() {
            document.getElementById('low-price-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('low-price-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeLowPriceFilter();
                    }
                });
            }
        });
        
        async function fetchLowPriceStocks() {
            const maxPrice = document.getElementById('filter-max-price').value || 10;
            const loadingEl = document.getElementById('filter-loading');
            const resultsEl = document.getElementById('filter-results');
            const emptyEl = document.getElementById('filter-empty');
            const listEl = document.getElementById('filter-stock-list');
            const countEl = document.getElementById('filter-count');
            const searchBtn = document.getElementById('filter-search-btn');
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            loadingEl.classList.remove('hidden');
            resultsEl.classList.add('hidden');
            emptyEl.classList.add('hidden');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æœå°‹ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/filter/low-price?max=${maxPrice}&limit=50`);
                const data = await response.json();
                
                loadingEl.classList.add('hidden');
                
                if (data.stocks && data.stocks.length > 0) {
                    resultsEl.classList.remove('hidden');
                    countEl.textContent = data.count;
                    
                    // æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨
                    listEl.innerHTML = data.stocks.map(stock => `
                        <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 hover:border-orange-500/50 transition-all cursor-pointer group"
                             onclick="selectFilteredStock('${stock.code}')">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                    <span class="text-orange-400 font-bold text-sm">${stock.code}</span>
                                </div>
                                <div>
                                    <p class="text-white font-medium group-hover:text-orange-400 transition-colors">${stock.name}</p>
                                    <p class="text-xs text-slate-500">${stock.industry}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold ${stock.price < 5 ? 'text-red-400' : 'text-orange-400'}">$${stock.price.toFixed(2)}</p>
                                <div class="flex gap-2 text-xs text-slate-500 justify-end">
                                    <span title="æœ¬ç›Šæ¯”">PE:${stock.pe || 'N/A'}</span>
                                    <span title="æ®–åˆ©ç‡">${stock.dividendYield || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    emptyEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('ç¯©é¸éŒ¯èª¤:', error);
                loadingEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                alert('ç¯©é¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fa-solid fa-search"></i> æœå°‹';
            }
        }
        
        function formatVolume(volume) {
            if (volume >= 100000000) return (volume / 100000000).toFixed(2) + 'å„„';
            if (volume >= 10000) return (volume / 10000).toFixed(1) + 'è¬';
            if (volume >= 1000) return (volume / 1000).toFixed(1) + 'K';
            return volume.toLocaleString();
        }
        
        function selectFilteredStock(code) {
            document.getElementById('ticker-input').value = code;
            closeLowPriceFilter();
            analyzeStock();
        }

        // ========== æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å‡½æ•¸ï¼ˆå‰ç«¯ç”¨æ–¼åœ–è¡¨é¡¯ç¤ºï¼‰==========
        function calculateMA(data, period) {
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                result.push(sum / period);
            }
            return result;
        }

        function calculateRSI(prices, period = 14) {
            const result = [];
            const gains = [];
            const losses = [];
            
            for (let i = 1; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                gains.push(change > 0 ? change : 0);
                losses.push(change < 0 ? -change : 0);
            }
            
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            for (let i = period; i < gains.length; i++) {
                avgGain = (avgGain * (period - 1) + gains[i]) / period;
                avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                
                const rs = avgGain / (avgLoss || 0.0001);
                const rsi = 100 - (100 / (1 + rs));
                result.push(rsi);
            }
            
            return result;
        }

        function calculateEMA(data, period) {
            const multiplier = 2 / (period + 1);
            const result = [data[0]];
            
            for (let i = 1; i < data.length; i++) {
                result.push((data[i] - result[result.length - 1]) * multiplier + result[result.length - 1]);
            }
            
            return result;
        }

        function calculateMACD(prices, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const emaFast = calculateEMA(prices, fastPeriod);
            const emaSlow = calculateEMA(prices, slowPeriod);
            
            const macdLine = [];
            const minLength = Math.min(emaFast.length, emaSlow.length);
            for (let i = 0; i < minLength; i++) {
                macdLine.push(emaFast[emaFast.length - minLength + i] - emaSlow[emaSlow.length - minLength + i]);
            }
            
            const signalLine = calculateEMA(macdLine, signalPeriod);
            const histogram = [];
            const signalLength = signalLine.length;
            for (let i = 0; i < signalLength; i++) {
                histogram.push(macdLine[macdLine.length - signalLength + i] - signalLine[i]);
            }
            
            return { macd: macdLine, signal: signalLine, histogram };
        }

        function calculateBollingerBands(prices, period = 20, stdDev = 2) {
            const ma = calculateMA(prices, period);
            const result = { upper: [], middle: ma, lower: [] };
            
            for (let i = period - 1; i < prices.length; i++) {
                const slice = prices.slice(i - period + 1, i + 1);
                const mean = ma[ma.length - (prices.length - i)];
                const variance = slice.reduce((sum, price) => sum + Math.pow(price - mean, 2), 0) / period;
                const standardDeviation = Math.sqrt(variance);
                
                result.upper.push(mean + (stdDev * standardDeviation));
                result.lower.push(mean - (stdDev * standardDeviation));
            }
            
            return result;
        }

        function calculateTechnicalIndicators(history) {
            if (!history || history.length < 14) {
                return null;
            }
            
            const sorted = [...history].sort((a, b) => {
                const dateA = a.date.split('/').map(Number);
                const dateB = b.date.split('/').map(Number);
                const yearA = dateA[0] + 1911;
                const yearB = dateB[0] + 1911;
                if (yearA !== yearB) return yearA - yearB;
                if (dateA[1] !== dateB[1]) return dateA[1] - dateB[1];
                return dateA[2] - dateB[2];
            });
            
            const closes = sorted.map(h => parseFloat(h.close) || 0);
            const volumes = sorted.map(h => parseInt(h.volume) || 0);
            const highs = sorted.map(h => parseFloat(h.high) || 0);
            const lows = sorted.map(h => parseFloat(h.low) || 0);
            
            const ma5 = calculateMA(closes, 5);
            const ma10 = calculateMA(closes, 10);
            const ma20 = calculateMA(closes, 20);
            const rsi = calculateRSI(closes, 14);
            const macd = calculateMACD(closes);
            const bollinger = calculateBollingerBands(closes, 20);
            const volumeMA = calculateMA(volumes, 20);
            
            const support = Math.min(...lows.slice(-20));
            const resistance = Math.max(...highs.slice(-20));
            
            return {
                ma5: ma5[ma5.length - 1],
                ma10: ma10[ma10.length - 1],
                ma20: ma20[ma20.length - 1],
                rsi: rsi[rsi.length - 1],
                macd: macd.macd[macd.macd.length - 1],
                signal: macd.signal[macd.signal.length - 1],
                histogram: macd.histogram[macd.histogram.length - 1],
                bollingerUpper: bollinger.upper[bollinger.upper.length - 1],
                bollingerMiddle: bollinger.middle[bollinger.middle.length - 1],
                bollingerLower: bollinger.lower[bollinger.lower.length - 1],
                volumeMA: volumeMA[volumeMA.length - 1],
                support: support,
                resistance: resistance,
                currentPrice: closes[closes.length - 1]
            };
        }

        // ========== å¾Œç«¯ API èª¿ç”¨å‡½æ•¸ ==========
        // æ‰€æœ‰æ•¸æ“šç²å–å’Œ AI åˆ†æéƒ½é€šéå¾Œç«¯ä¼ºæœå™¨è™•ç†

        // --- 1. ç‹€æ…‹èˆ‡åˆå§‹åŒ– ---
        let apiKey = localStorage.getItem('gemini_api_key');
        
        // æª¢æŸ¥ Key æ˜¯å¦å­˜åœ¨
        if (apiKey) {
            document.getElementById('key-modal').classList.add('hidden');
        }

        function showModal() {
            document.getElementById('key-modal').classList.remove('hidden');
        }

        function saveKey() {
            const input = document.getElementById('api-key-input');
            const val = input.value.trim();
            if (val) {
                apiKey = val;
                localStorage.setItem('gemini_api_key', apiKey);
                document.getElementById('key-modal').classList.add('hidden');
            } else {
                alert("è«‹è¼¸å…¥ API Key");
            }
        }

        // --- 2. ä¿å­˜è‚¡ç¥¨åŠŸèƒ½ ---
        // ä» localStorage åŠ è½½å·²ä¿å­˜çš„è‚¡ç¥¨
        function loadSavedStocks() {
            const saved = JSON.parse(localStorage.getItem('savedStocks') || '[]');
            const listContainer = document.getElementById('saved-stocks-list');
            const noSavedMsg = document.getElementById('no-saved-stocks');
            
            listContainer.innerHTML = '';
            
            if (saved.length === 0) {
                noSavedMsg.classList.remove('hidden');
                return;
            }
            
            noSavedMsg.classList.add('hidden');
            
            saved.forEach((stock, index) => {
                const stockItem = document.createElement('div');
                stockItem.className = 'group bg-slate-700/50 hover:bg-slate-700 px-4 py-2 rounded-lg border border-slate-600 hover:border-blue-500/50 transition-all cursor-pointer flex items-center gap-2';
                stockItem.innerHTML = `
                    <span class="text-sm font-medium text-white" onclick="selectSavedStock('${stock.ticker}')">${stock.ticker}(${stock.name})</span>
                    <button onclick="removeSavedStock(${index})" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition ml-1">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                `;
                listContainer.appendChild(stockItem);
            });
        }
        
        // ä¿å­˜å½“å‰è‚¡ç¥¨
        async function saveCurrentStock() {
            let input = document.getElementById('ticker-input').value.trim();
            const ticker = convertStockNameToTicker(input).toUpperCase();
            
            if (!ticker) {
                alert("è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæˆ–åç¨±ï¼");
                return;
            }
            
            // è·å–è‚¡ç¥¨åç§°ï¼ˆä»å½“å‰æ˜¾ç¤ºçš„ç»“æœæˆ–é€šè¿‡APIï¼‰
            let stockName = ticker;
            const resultArea = document.getElementById('result-area');
            if (!resultArea.classList.contains('hidden')) {
                const nameEl = document.getElementById('stock-name');
                if (nameEl && nameEl.innerText !== '--') {
                    stockName = nameEl.innerText;
                }
            }
            
            // å¦‚æœç»“æœåŒºåŸŸæ²¡æœ‰æ˜¾ç¤ºï¼Œå°è¯•é€šè¿‡åç«¯ API å¿«é€Ÿè·å–è‚¡ç¥¨åç§°
            if (stockName === ticker) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/stock/${ticker.toUpperCase()}`);
                    if (response.ok) {
                        const quote = await response.json();
                        if (quote && quote.longName) {
                            stockName = quote.longName;
                        }
                    }
                } catch (err) {
                    console.error('ç²å–è‚¡ç¥¨åç¨±å¤±æ•—:', err);
                }
            }
            
            // ä¿å­˜åˆ° localStorage
            const saved = JSON.parse(localStorage.getItem('savedStocks') || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = saved.find(s => s.ticker === ticker);
            if (exists) {
                alert(`${ticker}(${stockName}) å·²ç¶“åœ¨ä¿å­˜åˆ—è¡¨ä¸­ï¼`);
                return;
            }
            
            saved.push({ ticker, name: stockName, savedAt: new Date().toISOString() });
            localStorage.setItem('savedStocks', JSON.stringify(saved));
            
            // æ›´æ–°UI
            loadSavedStocks();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const saveBtn = document.getElementById('save-btn');
            const originalHTML = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fa-solid fa-check text-white"></i>';
            saveBtn.classList.add('bg-green-500');
            setTimeout(() => {
                saveBtn.innerHTML = originalHTML;
                saveBtn.classList.remove('bg-green-500');
            }, 1000);
        }
        
        // é€‰æ‹©å·²ä¿å­˜çš„è‚¡ç¥¨
        function selectSavedStock(ticker) {
            document.getElementById('ticker-input').value = ticker;
            analyzeStock();
        }
        
        // åˆ é™¤å·²ä¿å­˜çš„è‚¡ç¥¨
        function removeSavedStock(index) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘çˆ¶å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶
            const saved = JSON.parse(localStorage.getItem('savedStocks') || '[]');
            saved.splice(index, 1);
            localStorage.setItem('savedStocks', JSON.stringify(saved));
            loadSavedStocks();
        }
        
        // æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„è‚¡ç¥¨
        function clearAllSavedStocks() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„è‚¡ç¥¨å—ï¼Ÿ')) {
                localStorage.removeItem('savedStocks');
                loadSavedStocks();
            }
        }
        
        // æ›´æ–°å·²ä¿å­˜è‚¡ç¥¨çš„åç§°ï¼ˆå¦‚æœè‚¡ç¥¨å·²ä¿å­˜ï¼‰
        function updateSavedStockName(name) {
            let input = document.getElementById('ticker-input').value.trim();
            const ticker = convertStockNameToTicker(input).toUpperCase();
            const saved = JSON.parse(localStorage.getItem('savedStocks') || '[]');
            const stockIndex = saved.findIndex(s => s.ticker === ticker);
            
            if (stockIndex !== -1 && saved[stockIndex].name !== name) {
                saved[stockIndex].name = name;
                localStorage.setItem('savedStocks', JSON.stringify(saved));
                loadSavedStocks();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½å·²ä¿å­˜çš„è‚¡ç¥¨
        loadSavedStocks();
        
        // å°ç£è‚¡ç¥¨åç¨±åˆ°ä»£è™Ÿçš„æ˜ å°„è¡¨ï¼ˆå¸¸è¦‹è‚¡ç¥¨ï¼‰
        const stockNameMap = {
            'å°ç©é›»': '2330', 'å°ç©': '2330', 'TSMC': '2330',
            'è¯ç™¼ç§‘': '2454', 'è¯ç™¼': '2454', 'MediaTek': '2454',
            'é´»æµ·': '2317', 'é´»æµ·ç²¾å¯†': '2317', 'Foxconn': '2317',
            'å°é”é›»': '2308', 'å°é”': '2308', 'Delta': '2308',
            'ä¸­è¯é›»': '2412', 'ä¸­è¯é›»ä¿¡': '2412', 'CHT': '2412',
            'å¯Œé‚¦é‡‘': '2881', 'å¯Œé‚¦': '2881', 'Fubon': '2881',
            'åœ‹æ³°é‡‘': '2882', 'åœ‹æ³°': '2882', 'Cathay': '2882',
            'ä¸­é‹¼': '2002', 'ä¸­é‹¼å…¬å¸': '2002', 'CSC': '2002',
            'å°å¡‘': '1301', 'å°å¡‘å…¬å¸': '1301', 'Formosa': '1301',
            'å—äº': '1303', 'å—äºå¡‘è† ': '1303',
            'å°åŒ–': '1326', 'å°ç£åŒ–å­¸': '1326',
            'çµ±ä¸€': '1216', 'çµ±ä¸€ä¼æ¥­': '1216', 'Uni-President': '1216',
            'å¤§ç«‹å…‰': '3008', 'å¤§ç«‹': '3008', 'Largan': '3008',
            'è¯è© ': '3034', 'è¯è© ç§‘æŠ€': '3034',
            'ç‘æ˜±': '2379', 'ç‘æ˜±åŠå°é«”': '2379', 'Realtek': '2379',
            'ç¾¤å‰µ': '3481', 'ç¾¤å‰µå…‰é›»': '3481', 'Innolux': '3481',
            'å‹é”': '2409', 'å‹é”å…‰é›»': '2409', 'AUO': '2409',
            'é•·æ¦®': '2603', 'é•·æ¦®æµ·é‹': '2603', 'Evergreen': '2603',
            'é™½æ˜': '2609', 'é™½æ˜æµ·é‹': '2609', 'Yang Ming': '2609',
            'è¬æµ·': '2615', 'è¬æµ·èˆªé‹': '2615', 'Wan Hai': '2615',
            'å…ƒå¤§å°ç£50': '0050', 'å°ç£50': '0050', '0050': '0050',
            'å…ƒå¤§é«˜è‚¡æ¯': '0056', 'é«˜è‚¡æ¯': '0056', '0056': '0056',
            'å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯': '00940', '00940': '00940', 'åƒ¹å€¼é«˜æ¯': '00940',
            'å°æ–°é‡‘': '2887', 'å°æ–°': '2887',
            'ç‰å±±é‡‘': '2884', 'ç‰å±±': '2884',
            'ç¬¬ä¸€é‡‘': '2892', 'ç¬¬ä¸€': '2892',
            'å…†è±é‡‘': '2886', 'å…†è±': '2886',
            'è¯å—é‡‘': '2880', 'è¯å—': '2880',
            'é–‹ç™¼é‡‘': '2883', 'é–‹ç™¼': '2883',
            'ä¸­ä¿¡é‡‘': '2891', 'ä¸­ä¿¡': '2891',
            'æ°¸è±é‡‘': '2890', 'æ°¸è±': '2890',
            'æ–°å…‰é‡‘': '2888', 'æ–°å…‰': '2888',
            'åˆåº«é‡‘': '5880', 'åˆåº«': '5880',
            'æ—¥æœˆå…‰': '3711', 'æ—¥æœˆå…‰æŠ•æ§': '3711', 'ASE': '3711',
            'å»£é”': '2382', 'å»£é”é›»è…¦': '2382', 'Quanta': '2382',
            'ä»å¯¶': '2324', 'ä»å¯¶é›»è…¦': '2324', 'Compal': '2324',
            'å’Œç¢©': '4938', 'å’Œç¢©è¯åˆ': '4938', 'Pegatron': '4938',
            'è‹±æ¥­é”': '2356', 'è‹±æ¥­': '2356', 'Inventec': '2356',
            'å¾®æ˜Ÿ': '2377', 'å¾®æ˜Ÿç§‘æŠ€': '2377', 'MSI': '2377',
            'æŠ€å˜‰': '2376', 'æŠ€å˜‰ç§‘æŠ€': '2376', 'Gigabyte': '2376',
            'è¯ç¢©': '2357', 'è¯ç¢©é›»è…¦': '2357', 'ASUS': '2357',
            'å®ç¢': '2353', 'å®ç¢é›»è…¦': '2353', 'Acer': '2353',
            'å¯æˆ': '2474', 'å¯æˆç§‘æŠ€': '2474', 'Catcher': '2474',
            'å°æ³¥': '1101', 'å°ç£æ°´æ³¥': '1101',
            'äºæ³¥': '1102', 'äºæ´²æ°´æ³¥': '1102',
            'é å‚³': '4904', 'é å‚³é›»ä¿¡': '4904', 'Far EasTone': '4904',
            'å°ç£å¤§': '3045', 'å°ç£å¤§å“¥å¤§': '3045', 'Taiwan Mobile': '3045',
            'çµ±ä¸€è¶…': '2912', 'çµ±ä¸€è¶…å•†': '2912', '7-Eleven': '2912',
            'å…¨å®¶': '5903', 'å…¨å®¶ä¾¿åˆ©': '5903', 'FamilyMart': '5903',
            'ä¸­ç§Ÿ': '5871', 'ä¸­ç§Ÿæ§è‚¡': '5871',
            'è£•éš†': '2201', 'è£•éš†æ±½è»Š': '2201', 'Yulon': '2201',
            'å’Œæ³°è»Š': '2207', 'å’Œæ³°æ±½è»Š': '2207', 'Hotai': '2207',
            'è±ç”°': '2207', 'Toyota': '2207'
        };
        
        // å°‡ä¸­æ–‡è‚¡ç¥¨åç¨±è½‰æ›ç‚ºè‚¡ç¥¨ä»£è™Ÿ
        function convertStockNameToTicker(input) {
            const trimmed = input.trim();
            
            // å¦‚æœæ˜¯ç´”æ•¸å­—ï¼Œç›´æ¥è¿”å›ï¼ˆå¯èƒ½æ˜¯è‚¡ç¥¨ä»£è™Ÿï¼‰
            if (/^\d{4,5}$/.test(trimmed)) {
                return trimmed;
            }
            
            // æª¢æŸ¥æ˜ å°„è¡¨
            const ticker = stockNameMap[trimmed] || stockNameMap[trimmed.toUpperCase()];
            if (ticker) {
                return ticker;
            }
            
            // å˜—è©¦éƒ¨åˆ†åŒ¹é…ï¼ˆä¾‹å¦‚è¼¸å…¥"å°ç©"ä¹Ÿèƒ½æ‰¾åˆ°"å°ç©é›»"ï¼‰
            for (const [name, code] of Object.entries(stockNameMap)) {
                if (name.includes(trimmed) || trimmed.includes(name)) {
                    return code;
                }
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›åŸå§‹è¼¸å…¥ï¼ˆè®“å¾Œç«¯è™•ç†ï¼‰
            return trimmed;
        }
        
        // --- 3. æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ†æè‚¡ç¥¨ ---
        async function analyzeStock() {
            let input = document.getElementById('ticker-input').value.trim();
            
            if (!input) {
                alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿæˆ–åç¨±ï¼");
                return;
            }
            
            // è½‰æ›ä¸­æ–‡åç¨±ç‚ºè‚¡ç¥¨ä»£è™Ÿ
            const ticker = convertStockNameToTicker(input);
            
            // å¦‚æœè½‰æ›æˆåŠŸä¸”èˆ‡è¼¸å…¥ä¸åŒï¼Œæ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º
            if (ticker !== input && stockNameMap[input] || stockNameMap[input.toUpperCase()]) {
                document.getElementById('ticker-input').value = ticker;
            }

            // ä½¿ç”¨æ‰€æœ‰4ç¨®æŠ•è³‡é¢¨æ ¼
            const styles = [
                { value: 'åƒ¹å€¼æŠ•è³‡', label: 'ğŸ’ åƒ¹å€¼æŠ•è³‡ (å·´è²ç‰¹)', color: 'blue' },
                { value: 'çŸ­ç·šç•¶æ²–', label: 'âš¡ çŸ­ç·šç•¶æ²– (æŠ€è¡“é¢)', color: 'yellow' },
                { value: 'æˆé•·å‹æŠ•è³‡', label: 'ğŸš€ æˆé•·å‹æŠ•è³‡ (ç§‘æŠ€è‚¡)', color: 'purple' },
                { value: 'ä¿å®ˆå­˜è‚¡', label: 'ğŸ›¡ï¸ ä¿å®ˆå­˜è‚¡ (é ˜è‚¡æ¯)', color: 'green' }
            ];

            // UI ç‹€æ…‹åˆ‡æ›
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result-area').classList.add('hidden');
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('analyze-btn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> åˆ†æä¸­...';

            try {
                // èª¿ç”¨å¾Œç«¯ API ç²å–è‚¡ç¥¨æ•¸æ“šå’Œ AI åˆ†æ
                console.log(`æ­£åœ¨èª¿ç”¨å¾Œç«¯ API åˆ†æè‚¡ç¥¨: ${ticker}`);
                
                const response = await fetch(`${API_BASE_URL}/api/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ticker: ticker.toUpperCase(),
                        apiKey: apiKey
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('å¾Œç«¯è¿”å›æ•¸æ“š:', result);
                
                // åˆ¤æ–·æ˜¯å¦ç‚º ETFï¼ˆä»£ç¢¼ä»¥ 0 é–‹é ­ï¼Œå¦‚ 0050ã€0056ã€00940ï¼‰
                const isETF = /^0/.test(ticker);
                const etfNote = 'ETFä¸é©ç”¨';
                
                // æ§‹å»ºè¿”å›æ•¸æ“šæ ¼å¼
                const data = {
                    market_data: {
                        name: result.marketData.name,
                        price: result.marketData.price,
                        change: result.marketData.change,
                        // ETF é€šå¸¸æ²’æœ‰æœ¬ç›Šæ¯”ï¼Œé¡¯ç¤ºã€ŒETFä¸é©ç”¨ã€
                        pe: result.marketData.pe ? result.marketData.pe.toFixed(2) : (isETF ? etfNote : 'N/A'),
                        dividendYield: result.marketData.dividendYield ? result.marketData.dividendYield.toFixed(2) : 'N/A',
                        // ETF é€šå¸¸æ²’æœ‰è‚¡åƒ¹æ·¨å€¼æ¯”ï¼Œé¡¯ç¤ºã€ŒETFä¸é©ç”¨ã€
                        pb: result.marketData.pb ? result.marketData.pb.toFixed(2) : (isETF ? etfNote : 'N/A'),
                        marketCap: result.marketData.marketCap || 0,
                        volume: result.marketData.volume,
                        previousClose: result.marketData.previousClose,
                        dayHigh: result.marketData.dayHigh,
                        dayLow: result.marketData.dayLow,
                        fiftyTwoWeekHigh: result.marketData.fiftyTwoWeekHigh,
                        fiftyTwoWeekLow: result.marketData.fiftyTwoWeekLow,
                        isDemo: false,
                        isETF: isETF,  // æ¨™è¨˜æ˜¯å¦ç‚º ETF
                        // ç±Œç¢¼é¢æ•¸æ“š
                        institutional: result.marketData.institutional,
                        margin: result.marketData.margin,
                        revenue: result.marketData.revenue
                    },
                    technical_indicators: result.technicalIndicators,
                    analyses: result.analyses.map((analysis, i) => ({
                        style: result.styles[i],
                        summary: analysis.summary || 'åˆ†æä¸­...',
                        analysis: analysis.analysis || 'åˆ†æä¸­...',
                        action: analysis.action || 'æŒæœ‰',
                        risk_level: analysis.risk_level || 'ä¸­',
                        target_price: analysis.target_price || 'N/A',
                        stop_loss: analysis.stop_loss || 'N/A',
                        time_horizon: analysis.time_horizon || 'N/A',
                        position_sizing: analysis.position_sizing || 'N/A',
                        bullish_points: analysis.bullish_points || [],
                        bearish_points: analysis.bearish_points || [],
                        key_levels: analysis.key_levels || {},
                        industry_comparison: analysis.industry_comparison || 'N/A',
                        catalyst: analysis.catalyst || 'N/A'
                    })),
                    history: result.history
                };
                
                // é©—è­‰æ•¸æ“šçµæ§‹
                if (!data || !data.market_data) {
                    alert("ä¼ºæœå™¨è¿”å›çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    console.error('ç„¡æ•ˆçš„æ•¸æ“šçµæ§‹:', data);
                    return;
                }
                
                // è™•ç†æ‰¾ä¸åˆ°è‚¡ç¥¨çš„æƒ…æ³
                if (data.analysis && data.analysis.includes("æ‰¾ä¸åˆ°")) {
                    alert(data.analysis);
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªé£æ ¼çš„åˆ†æç»“æœ
                console.log('æ¥æ”¶åˆ°çš„å®Œæ•´æ•°æ®:', JSON.stringify(data, null, 2));
                console.log('analyses æ•°æ®:', data.analyses);
                console.log('analyses ç±»å‹:', typeof data.analyses, 'æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(data.analyses));
                
                if (data.analyses && Array.isArray(data.analyses) && data.analyses.length > 0) {
                    console.log('âœ… ä½¿ç”¨å¤šé£æ ¼æ¸²æŸ“ï¼Œåˆ†ææ•°é‡:', data.analyses.length);
                    renderMultiStyleData(data, styles);
                } else if (data.summary || data.analysis) {
                    console.log('âš ï¸ ä½¿ç”¨å•é£æ ¼æ¸²æŸ“ï¼ˆå‘åå…¼å®¹ï¼‰');
                renderData(data);
                } else {
                    console.error('âŒ æ²¡æœ‰æ‰¾åˆ°åˆ†æç»“æœ');
                    console.error('æ•°æ®å†…å®¹:', data);
                    // å³ä½¿æ²¡æœ‰åˆ†æç»“æœï¼Œä¹Ÿæ˜¾ç¤ºå¸‚åœºæ•°æ®
                    if (data.market_data) {
                        renderMultiStyleData({ ...data, analyses: [] }, styles);
                    } else {
                        alert('æœªæ”¶åˆ°åˆ†æç»“æœï¼Œè¯·ç¨åé‡è¯•ã€‚');
                    }
                }

            } catch (error) {
                console.error(error);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('analyze-btn').disabled = false;
                document.getElementById('analyze-btn').innerHTML = '<span>AI åˆ†æ</span> <i class="fa-solid fa-wand-magic-sparkles"></i>';
            }
        }

        // --- 3. æ¸²æŸ“å¤šé¢¨æ ¼åˆ†æçµæœ ---
        function renderMultiStyleData(data, styles) {
            document.getElementById('result-area').classList.remove('hidden');
            const m = data.market_data;

            // --- A. å¡«å¯«å¸‚å ´æ•¸æ“š ---
            document.getElementById('stock-name').innerText = m.name;
            document.getElementById('stock-price').innerText = m.price.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
            // è™•ç† ETF çš„æœ¬ç›Šæ¯”é¡¯ç¤º
            // å³æ™‚è¡Œæƒ…å€çš„æœ¬ç›Šæ¯”
            const stockPeEl = document.getElementById('stock-pe');
            if (m.isETF && m.pe === 'ETFä¸é©ç”¨') {
                stockPeEl.innerHTML = `<i class="fa-solid fa-chart-pie text-xs text-slate-500"></i> <span class="text-slate-400 text-xs">ETF</span>`;
            } else if (m.pe === 'N/A' || !m.pe || m.pe === 'null') {
                stockPeEl.innerHTML = `<i class="fa-solid fa-chart-pie text-xs text-slate-500"></i> <span class="text-slate-400 text-xs">æœ¬ç›Šæ¯”: æš«ç„¡</span>`;
            } else {
                stockPeEl.innerHTML = `<i class="fa-solid fa-chart-pie text-xs"></i> <span>æœ¬ç›Šæ¯”: ${m.pe}</span>`;
            }
            
            if (m.isDemo) {
                stockPeEl.innerHTML = `<span class="text-yellow-500">âš ï¸ æ¼”ç¤ºæ•¸æ“š</span>`;
            }
            
            // å¡«å¯«è²¡å‹™æŒ‡æ¨™ï¼ˆETF é¡¯ç¤ºç‰¹æ®Šæ¨£å¼ï¼ŒN/A é¡¯ç¤ºå‹å–„èªªæ˜ï¼‰
            const peEl = document.getElementById('metric-pe');
            const pbEl = document.getElementById('metric-pb');
            const dividendEl = document.getElementById('metric-dividend');
            const volumeEl = document.getElementById('metric-volume');
            
            // æœ¬ç›Šæ¯”
            if (m.pe === 'ETFä¸é©ç”¨') {
                peEl.innerHTML = `<span class="text-slate-500 text-sm">ETFä¸é©ç”¨</span>`;
            } else if (m.pe === 'N/A' || !m.pe) {
                peEl.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šè™§æä¸­æˆ–è³‡æ–™æœªå…¬é–‹">æš«ç„¡è³‡æ–™</span>`;
            } else {
                peEl.innerText = m.pe;
            }
            
            // è‚¡æ¯ç‡
            if (m.dividendYield !== 'N/A' && m.dividendYield) {
                dividendEl.innerText = `${m.dividendYield}%`;
            } else {
                dividendEl.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šè¿‘ä¸€å¹´æœªé…æ¯">æœªé…æ¯</span>`;
            }
            
            // è‚¡åƒ¹æ·¨å€¼æ¯”
            if (m.pb === 'ETFä¸é©ç”¨') {
                pbEl.innerHTML = `<span class="text-slate-500 text-sm">ETFä¸é©ç”¨</span>`;
            } else if (m.pb === 'N/A' || !m.pb) {
                pbEl.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šè³‡æ–™æœªå…¬é–‹æˆ–è¨ˆç®—ä¸­">æš«ç„¡è³‡æ–™</span>`;
            } else {
                pbEl.innerText = m.pb;
            }
            
            // æˆäº¤é‡
            if (m.volume > 0) {
                if (m.volume >= 1000000) {
                    volumeEl.innerText = `${(m.volume / 1000000).toFixed(2)}M`;
                } else if (m.volume >= 1000) {
                    volumeEl.innerText = `${(m.volume / 1000).toFixed(1)}K`;
                } else {
                    volumeEl.innerText = m.volume.toLocaleString();
                }
            } else {
                volumeEl.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šä¼‘å¸‚æˆ–åœç‰Œ">ä¼‘å¸‚ä¸­</span>`;
            }
            
            // å¡«å¯«åƒ¹æ ¼å€é–“ï¼ˆN/A æ”¹ç‚ºå‹å–„èªªæ˜ï¼‰
            const formatPrice = (value, el, hint) => {
                if (value > 0) {
                    el.innerText = value.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                } else {
                    el.innerHTML = `<span class="text-slate-500 text-sm" title="${hint}">--</span>`;
                }
            };
            
            formatPrice(m.previousClose, document.getElementById('metric-prev-close'), 'å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›¤åƒ¹');
            formatPrice(m.dayHigh, document.getElementById('metric-high'), 'ä»Šæ—¥å°šæœªæœ‰æˆäº¤');
            formatPrice(m.dayLow, document.getElementById('metric-low'), 'ä»Šæ—¥å°šæœªæœ‰æˆäº¤');
            formatPrice(m.fiftyTwoWeekHigh, document.getElementById('metric-52w-high'), 'è³‡æ–™ä¸è¶³52é€±');
            formatPrice(m.fiftyTwoWeekLow, document.getElementById('metric-52w-low'), 'è³‡æ–™ä¸è¶³52é€±');

            // --- B. å¡«å¯«ç±Œç¢¼é¢æ•¸æ“š ---
            const chipSection = document.getElementById('chip-data-section');
            if (m.institutional || m.margin || m.revenue) {
                chipSection.classList.remove('hidden');
                
                // ä¸‰å¤§æ³•äºº
                if (m.institutional) {
                    const inst = m.institutional;
                    const formatNum = (n) => {
                        if (!n) return '--';
                        const absN = Math.abs(n);
                        const sign = n >= 0 ? '+' : '';
                        if (absN >= 1000000) return sign + (n / 1000000).toFixed(2) + 'M';
                        if (absN >= 1000) return sign + (n / 1000).toFixed(1) + 'K';
                        return sign + n.toLocaleString();
                    };
                    
                    const foreignTodayEl = document.getElementById('chip-foreign-today');
                    foreignTodayEl.innerText = formatNum(inst.foreign?.today);
                    foreignTodayEl.className = `text-xl font-bold ${inst.foreign?.today >= 0 ? 'text-red-400' : 'text-green-400'}`;
                    document.getElementById('chip-foreign-total').innerText = `è¿‘${inst.days}æ—¥: ${formatNum(inst.foreign?.total)}`;
                    
                    const trustTodayEl = document.getElementById('chip-trust-today');
                    trustTodayEl.innerText = formatNum(inst.investmentTrust?.today);
                    trustTodayEl.className = `text-xl font-bold ${inst.investmentTrust?.today >= 0 ? 'text-red-400' : 'text-green-400'}`;
                    document.getElementById('chip-trust-total').innerText = `è¿‘${inst.days}æ—¥: ${formatNum(inst.investmentTrust?.total)}`;
                    
                    const dealerTodayEl = document.getElementById('chip-dealer-today');
                    dealerTodayEl.innerText = formatNum(inst.dealer?.today);
                    dealerTodayEl.className = `text-xl font-bold ${inst.dealer?.today >= 0 ? 'text-red-400' : 'text-green-400'}`;
                    document.getElementById('chip-dealer-total').innerText = `è¿‘${inst.days}æ—¥: ${formatNum(inst.dealer?.total)}`;
                }
                
                // èè³‡èåˆ¸
                if (m.margin) {
                    const margin = m.margin;
                    document.getElementById('chip-margin-balance').innerText = margin.marginBalance ? (margin.marginBalance / 1000).toFixed(1) + 'Kå¼µ' : '--';
                    
                    const marginChangeEl = document.getElementById('chip-margin-change');
                    const marginChange = margin.marginChange || 0;
                    marginChangeEl.innerText = (marginChange >= 0 ? '+' : '') + marginChange.toLocaleString();
                    marginChangeEl.className = `text-lg font-bold ${marginChange >= 0 ? 'text-red-400' : 'text-green-400'}`;
                    
                    document.getElementById('chip-short-balance').innerText = margin.shortBalance ? (margin.shortBalance / 1000).toFixed(1) + 'Kå¼µ' : '--';
                    document.getElementById('chip-ratio').innerText = margin.marginShortRatio ? margin.marginShortRatio + '%' : '--';
                }
                
                // æœˆç‡Ÿæ”¶
                if (m.revenue) {
                    const rev = m.revenue;
                    document.getElementById('revenue-latest').innerText = rev.revenue ? (rev.revenue / 100000000).toFixed(2) + 'å„„' : '--';
                    
                    const yoyEl = document.getElementById('revenue-yoy');
                    if (rev.yoyGrowth !== null) {
                        yoyEl.innerText = (rev.yoyGrowth >= 0 ? '+' : '') + rev.yoyGrowth + '%';
                        yoyEl.className = `text-lg font-bold ${rev.yoyGrowth >= 0 ? 'text-red-400' : 'text-green-400'}`;
                    } else {
                        yoyEl.innerText = 'N/A';
                        yoyEl.className = 'text-lg font-bold text-slate-400';
                    }
                    
                    document.getElementById('revenue-avg3m').innerText = rev.avg3MonthRevenue ? (rev.avg3MonthRevenue / 100000000).toFixed(2) + 'å„„' : '--';
                    
                    const trendEl = document.getElementById('revenue-trend');
                    trendEl.innerText = rev.isGrowing ? 'ğŸ“ˆ æˆé•·' : 'ğŸ“‰ è¡°é€€';
                    trendEl.className = `text-lg font-bold ${rev.isGrowing ? 'text-red-400' : 'text-green-400'}`;
                }
            } else {
                chipSection.classList.add('hidden');
            }

            // è™•ç†æ¼²è·Œé¡è‰²
            const changeStr = m.change || "0%";
            const isUp = !changeStr.includes('-');
            const changeEl = document.getElementById('stock-change');
            changeEl.innerText = changeStr;
            if (isUp) {
                changeEl.className = "text-xl font-bold flex items-center justify-end gap-1 stock-up";
                changeEl.innerHTML += ' <i class="fa-solid fa-caret-up"></i>';
            } else {
                changeEl.className = "text-xl font-bold flex items-center justify-end gap-1 stock-down";
                changeEl.innerHTML += ' <i class="fa-solid fa-caret-down"></i>';
            }

            // æ›´æ–°å·²ä¿å­˜çš„è‚¡ç¥¨åˆ—è¡¨
            updateSavedStockName(m.name);

            // æ¸²æŸ“åœ–è¡¨
            if (data.history && data.history.length > 0) {
                renderCharts(data.history);
            } else {
                const priceChartContainer = document.getElementById('price-chart').parentElement;
                const volumeChartContainer = document.getElementById('volume-chart').parentElement;
                priceChartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-slate-500"><p>æš«ç„¡æ­·å²æ•¸æ“šï¼Œç„¡æ³•é¡¯ç¤ºæŠ€è¡“ç·šåœ–</p></div>';
                volumeChartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-slate-500"><p>æš«ç„¡æ­·å²æ•¸æ“šï¼Œç„¡æ³•é¡¯ç¤ºæŠ€è¡“ç·šåœ–</p></div>';
            }

            // æ¸²æŸ“å¤šé¢¨æ ¼åˆ†æçµæœ
            const container = document.getElementById('multi-style-analysis');
            if (!container) {
                console.error('æ‰¾ä¸åˆ° multi-style-analysis å®¹å™¨ï¼Œå˜—è©¦å‰µå»º...');
                // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œå‰µå»ºå®ƒ
                const resultArea = document.getElementById('result-area');
                if (resultArea) {
                    const newContainer = document.createElement('div');
                    newContainer.id = 'multi-style-analysis';
                    newContainer.className = 'space-y-4';
                    // æ’å…¥åˆ°æŠ€è¡“ç·šåœ–ä¹‹å¾Œ
                    const chartsContainer = resultArea.querySelector('.bg-slate-800.rounded-2xl');
                    if (chartsContainer && chartsContainer.nextSibling) {
                        resultArea.insertBefore(newContainer, chartsContainer.nextSibling);
                    } else {
                        resultArea.appendChild(newContainer);
                    }
                    newContainer.innerHTML = '';
                    return renderMultiStyleData(data, styles);
                } else {
                    console.error('æ‰¾ä¸åˆ° result-area å®¹å™¨');
                    return;
                }
            }
            
            // ç¡®ä¿å®¹å™¨å¯è§
            container.classList.remove('hidden');
            
            // æª¢æŸ¥æ˜¯å¦æœ‰åˆ†æçµæœ
            const analyses = data.analyses || [];
            console.log('å‡†å¤‡æ¸²æŸ“å¤šé£æ ¼åˆ†æï¼Œanalyses:', analyses, 'styles:', styles);
            
            // ä¿å­˜åˆ†æç»“æœåˆ°å…¨å±€å˜é‡ï¼Œä¾›æ ‡ç­¾åˆ‡æ¢ä½¿ç”¨
            window.currentAnalyses = analyses;
            window.currentStyles = styles;
            
            if (analyses.length === 0) {
                container.innerHTML = '<div class="text-center py-8"><p class="text-slate-400">åˆ†æçµæœå°šæœªè¿”å›ï¼Œè«‹ç¨å€™...</p></div>';
                return;
            }
            
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªé£æ ¼
            switchStyleTab(0);
            
            // ä¿å­˜å®Œæ•´æ•°æ®ä¾›å¯¼å‡ºä½¿ç”¨
            window.currentMarketData = data.market_data;
            window.currentHistory = data.history;
        }
        
        // åŒ¯å‡ºç‚º LINE ç­†è¨˜æœ¬æ ¼å¼
        function exportToLineNotebook() {
            const marketData = window.currentMarketData;
            const analyses = window.currentAnalyses || [];
            const styles = window.currentStyles || [];
            const history = window.currentHistory || [];
            
            if (!marketData || analyses.length === 0) {
                alert('æ²’æœ‰å¯åŒ¯å‡ºçš„åˆ†æçµæœ');
                return;
            }
            
            const now = new Date();
            const dateStr = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            let content = '';
            content += 'â•'.repeat(50) + '\n';
            content += `ğŸ“Š ${marketData.name} (${document.getElementById('ticker-input').value.toUpperCase()}) è‚¡ç¥¨åˆ†æå ±å‘Š\n`;
            content += `ğŸ“… åˆ†ææ™‚é–“ï¼š${dateStr}\n`;
            content += 'â•'.repeat(50) + '\n\n';
            
            // åŸºæœ¬è³‡è¨Š
            content += 'ã€åŸºæœ¬è³‡è¨Šã€‘\n';
            content += 'â”€'.repeat(30) + '\n';
            content += `è‚¡ç¥¨ä»£è™Ÿï¼š${document.getElementById('ticker-input').value.toUpperCase()}\n`;
            content += `å…¬å¸åç¨±ï¼š${marketData.name}\n`;
            content += `ç•¶å‰åƒ¹æ ¼ï¼š${marketData.price.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
            content += `æ¼²è·Œå¹…ï¼š${marketData.change}\n`;
            content += `æœ¬ç›Šæ¯” (PE)ï¼š${marketData.pe}\n`;
            if (marketData.dividendYield && marketData.dividendYield !== 'N/A') {
                content += `è‚¡æ¯ç‡ï¼š${marketData.dividendYield}%\n`;
            }
            if (marketData.pb && marketData.pb !== 'N/A') {
                content += `è‚¡åƒ¹æ·¨å€¼æ¯” (PB)ï¼š${marketData.pb}\n`;
            }
            content += `æˆäº¤é‡ï¼š${marketData.volume > 0 ? (marketData.volume >= 1000000 ? `${(marketData.volume / 1000000).toFixed(2)}M` : marketData.volume >= 1000 ? `${(marketData.volume / 1000).toFixed(1)}K` : marketData.volume.toLocaleString()) : 'N/A'}\n`;
            content += `å‰æ”¶ç›¤åƒ¹ï¼š${marketData.previousClose > 0 ? marketData.previousClose.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A'}\n`;
            content += `ä»Šæ—¥æœ€é«˜ï¼š${marketData.dayHigh > 0 ? marketData.dayHigh.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A'}\n`;
            content += `ä»Šæ—¥æœ€ä½ï¼š${marketData.dayLow > 0 ? marketData.dayLow.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'N/A'}\n`;
            if (marketData.fiftyTwoWeekHigh > 0) {
                content += `52é€±æœ€é«˜ï¼š${marketData.fiftyTwoWeekHigh.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
            }
            if (marketData.fiftyTwoWeekLow > 0) {
                content += `52é€±æœ€ä½ï¼š${marketData.fiftyTwoWeekLow.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n`;
            }
            content += '\n';
            
            // å„é¢¨æ ¼åˆ†æ
            content += 'ã€AI å°ˆæ¥­åˆ†æã€‘\n';
            content += 'â•'.repeat(50) + '\n\n';
            
            analyses.forEach((analysis, index) => {
                const style = styles[index];
                if (!style || !analysis) return;
                
                const styleEmoji = {
                    'åƒ¹å€¼æŠ•è³‡': 'ğŸ’',
                    'çŸ­ç·šç•¶æ²–': 'âš¡',
                    'æˆé•·å‹æŠ•è³‡': 'ğŸš€',
                    'ä¿å®ˆå­˜è‚¡': 'ğŸ›¡ï¸'
                };
                
                content += `${styleEmoji[style.value] || 'ğŸ“Œ'} ${style.label}\n`;
                content += 'â”€'.repeat(30) + '\n';
                
                if (analysis.action) {
                    content += `æ“ä½œå»ºè­°ï¼š${analysis.action}\n`;
                }
                if (analysis.risk_level) {
                    content += `é¢¨éšªç­‰ç´šï¼š${analysis.risk_level}\n`;
                }
                if (analysis.target_price && analysis.target_price !== 'N/A') {
                    content += `ç›®æ¨™åƒ¹ä½ï¼š${analysis.target_price}\n`;
                }
                if (analysis.stop_loss && analysis.stop_loss !== 'N/A') {
                    content += `æ­¢æåƒ¹ä½ï¼š${analysis.stop_loss}\n`;
                }
                if (analysis.time_horizon && analysis.time_horizon !== 'N/A') {
                    content += `æŠ•è³‡æ™‚ç¨‹ï¼š${analysis.time_horizon}\n`;
                }
                if (analysis.position_sizing && analysis.position_sizing !== 'N/A') {
                    content += `å»ºè­°å€‰ä½ï¼š${analysis.position_sizing}\n`;
                }
                content += '\n';
                
                if (analysis.key_levels) {
                    if (analysis.key_levels.support || analysis.key_levels.resistance || analysis.key_levels.breakout) {
                        content += 'é—œéµåƒ¹ä½ï¼š\n';
                        if (analysis.key_levels.support) {
                            content += `  æ”¯æ’ä½ï¼š${analysis.key_levels.support}\n`;
                        }
                        if (analysis.key_levels.resistance) {
                            content += `  é˜»åŠ›ä½ï¼š${analysis.key_levels.resistance}\n`;
                        }
                        if (analysis.key_levels.breakout) {
                            content += `  çªç ´ä½ï¼š${analysis.key_levels.breakout}\n`;
                        }
                        content += '\n';
                    }
                }
                
                if (analysis.summary) {
                    content += 'å¸‚å ´ç¸½çµï¼š\n';
                    content += `${analysis.summary}\n\n`;
                }
                
                if (analysis.bullish_points && analysis.bullish_points.length > 0) {
                    content += 'âœ… çœ‹å¤šè¨Šè™Ÿï¼š\n';
                    analysis.bullish_points.forEach((point, i) => {
                        content += `  ${i + 1}. ${point}\n`;
                    });
                    content += '\n';
                }
                
                if (analysis.bearish_points && analysis.bearish_points.length > 0) {
                    content += 'âš ï¸ é¢¨éšªè­¦ç¤ºï¼š\n';
                    analysis.bearish_points.forEach((point, i) => {
                        content += `  ${i + 1}. ${point}\n`;
                    });
                    content += '\n';
                }
                
                if (analysis.industry_comparison && analysis.industry_comparison !== 'N/A') {
                    content += 'è¡Œæ¥­å°æ¯”åˆ†æï¼š\n';
                    content += `${analysis.industry_comparison}\n\n`;
                }
                
                if (analysis.catalyst && analysis.catalyst !== 'N/A') {
                    content += 'æ½›åœ¨å‚¬åŒ–åŠ‘ï¼š\n';
                    content += `${analysis.catalyst}\n\n`;
                }
                
                if (analysis.analysis) {
                    content += 'è©³ç´°åˆ†æï¼š\n';
                    content += `${analysis.analysis}\n\n`;
                }
                
                content += 'â”€'.repeat(50) + '\n\n';
            });
            
            // å…è²¬è²æ˜
            content += 'ã€å…è²¬è²æ˜ã€‘\n';
            content += 'â”€'.repeat(30) + '\n';
            content += 'æœ¬åˆ†æå ±å‘Šç”± AI è‡ªå‹•ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸ä»£è¡¨ä»»ä½•æŠ•è³‡å»ºè­°ã€‚\n';
            content += 'æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹è¬¹æ…è©•ä¼°ä¸¦è‡ªè¡Œæ‰¿æ“”æŠ•è³‡è²¬ä»»ã€‚\n';
            content += 'è³‡æ–™ä¾†æºï¼šFinMind å°è‚¡è³‡æ–™åº«ã€Google Gemini AI\n';
            content += `ç”Ÿæˆæ™‚é–“ï¼š${dateStr}\n`;
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob(['\ufeff' + content], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${marketData.name}_${document.getElementById('ticker-input').value.toUpperCase()}_åˆ†æå ±å‘Š_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const btn = event.target.closest('button');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> <span class="hidden sm:inline">å·²åŒ¯å‡º</span>';
                btn.classList.add('bg-green-500');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-500');
                }, 2000);
            }
        }
        
        // åˆ‡æ›é¢¨æ ¼æ¨™ç±¤
        function switchStyleTab(index) {
            const container = document.getElementById('multi-style-analysis');
            if (!container) return;
            
            const analyses = window.currentAnalyses || [];
            const styles = window.currentStyles || [];
            
            if (index < 0 || index >= styles.length) return;
            
            // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•æ¨£å¼
            const colorMap = {
                blue: { active: 'border-blue-400 text-blue-400', inactive: 'text-slate-400 hover:text-slate-200' },
                yellow: { active: 'border-yellow-400 text-yellow-400', inactive: 'text-slate-400 hover:text-slate-200' },
                purple: { active: 'border-purple-400 text-purple-400', inactive: 'text-slate-400 hover:text-slate-200' },
                green: { active: 'border-green-400 text-green-400', inactive: 'text-slate-400 hover:text-slate-200' }
            };
            
            for (let i = 0; i < 4; i++) {
                const tabBtn = document.getElementById(`style-tab-${i}`);
                if (tabBtn) {
                    if (i === index) {
                        const style = styles[i];
                        const colors = colorMap[style?.color] || colorMap.blue;
                        tabBtn.className = `style-tab-btn flex-1 px-5 py-4 text-sm font-bold transition-all border-b-2 ${colors.active} bg-slate-800/30 min-w-[140px]`;
                    } else {
                        tabBtn.className = `style-tab-btn flex-1 px-5 py-4 text-sm font-bold transition-all border-b-2 border-transparent text-slate-400 hover:text-slate-200 min-w-[140px]`;
                    }
                }
            }
            
            // ç²å–ç•¶å‰é¢¨æ ¼çš„åˆ†æçµæœ
            const style = styles[index];
            let analysis = analyses[index] || 
                          analyses.find(a => a.style === style.value) ||
                          analyses.find(a => a.style && a.style.includes(style.value)) ||
                          null;
            
            const colorClasses = {
                blue: { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/30' },
                yellow: { bg: 'bg-yellow-500/20', text: 'text-yellow-400', border: 'border-yellow-500/30' },
                purple: { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/30' },
                green: { bg: 'bg-green-500/20', text: 'text-green-400', border: 'border-green-500/30' }
            };
            
            const colors = colorClasses[style.color] || colorClasses.blue;
            
            if (analysis) {
                container.innerHTML = `
                    <div class="animate-fade-in">
                        <!-- æ“ä½œå»ºè­°å¡ç‰‡ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                                <div class="text-xs text-slate-400 mb-1">æ“ä½œå»ºè­°</div>
                                <div class="text-lg font-bold ${colors.text}">${analysis.action || '--'}</div>
                            </div>
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                                <div class="text-xs text-slate-400 mb-1">é¢¨éšªç­‰ç´š</div>
                                <div class="text-lg font-bold text-slate-200">${analysis.risk_level || '--'}</div>
                            </div>
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                                <div class="text-xs text-slate-400 mb-1">ç›®æ¨™åƒ¹</div>
                                <div class="text-lg font-bold text-green-400">${analysis.target_price && analysis.target_price !== 'N/A' ? analysis.target_price : '<span class="text-slate-500 text-sm">åˆ†æä¸­</span>'}</div>
                            </div>
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                                <div class="text-xs text-slate-400 mb-1">æ­¢æåƒ¹</div>
                                <div class="text-lg font-bold text-red-400">${analysis.stop_loss && analysis.stop_loss !== 'N/A' ? analysis.stop_loss : '<span class="text-slate-500 text-sm">åˆ†æä¸­</span>'}</div>
                            </div>
                        </div>
                        
                        <!-- æŠ•è³‡åƒæ•¸ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                                <div class="text-xs text-slate-400 mb-1">æŠ•è³‡æ™‚ç¨‹</div>
                                <div class="text-sm font-semibold text-slate-200">${analysis.time_horizon && analysis.time_horizon !== 'N/A' ? analysis.time_horizon : '<span class="text-slate-500 text-sm">ä¾é¢¨æ ¼è€Œå®š</span>'}</div>
                            </div>
                            <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700">
                                <div class="text-xs text-slate-400 mb-1">å»ºè­°å€‰ä½</div>
                                <div class="text-sm font-semibold text-slate-200">${analysis.position_sizing && analysis.position_sizing !== 'N/A' ? analysis.position_sizing : '<span class="text-slate-500 text-sm">ä¾è³‡é‡‘é…ç½®</span>'}</div>
                            </div>
                        </div>
                        
                        <!-- é—œéµåƒ¹ä½ -->
                        ${analysis.key_levels && (analysis.key_levels.support || analysis.key_levels.resistance) ? `
                        <div class="bg-slate-900/50 rounded-xl p-4 border border-slate-700 mb-6">
                            <h4 class="text-sm font-bold text-slate-300 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-chart-line"></i> é—œéµåƒ¹ä½
                            </h4>
                            <div class="grid grid-cols-3 gap-3 text-sm">
                                ${analysis.key_levels.support ? `<div><span class="text-slate-400">æ”¯æ’ä½:</span> <span class="text-green-400 font-bold">${analysis.key_levels.support}</span></div>` : ''}
                                ${analysis.key_levels.resistance ? `<div><span class="text-slate-400">é˜»åŠ›ä½:</span> <span class="text-red-400 font-bold">${analysis.key_levels.resistance}</span></div>` : ''}
                                ${analysis.key_levels.breakout ? `<div><span class="text-slate-400">çªç ´ä½:</span> <span class="text-yellow-400 font-bold">${analysis.key_levels.breakout}</span></div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- å¸‚å ´ç¸½çµ -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-slate-200 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-chart-pie"></i> å¸‚å ´ç¸½çµ
                            </h3>
                            <p class="text-slate-200 leading-relaxed italic text-base bg-slate-900/30 rounded-lg p-4 border border-slate-700">${analysis.summary || 'åˆ†æä¸­...'}</p>
                        </div>
                        
                        <!-- çœ‹å¤šè¨Šè™Ÿèˆ‡é¢¨éšªè­¦ç¤º -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-slate-900/50 rounded-xl p-5 border border-slate-700">
                                <h4 class="text-green-400 font-bold mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-arrow-trend-up"></i> çœ‹å¤šè¨Šè™Ÿ
                                </h4>
                                <ul class="space-y-3 text-sm text-slate-300">
                                    ${(analysis.bullish_points || []).length > 0 
                                        ? (analysis.bullish_points || []).map(point => `<li class="flex items-start gap-2"><i class="fa-solid fa-check text-green-400 mt-1 flex-shrink-0"></i><span>${point}</span></li>`).join('')
                                        : '<li class="text-slate-500">æš«ç„¡çœ‹å¤šè¨Šè™Ÿ</li>'
                                    }
                                </ul>
                            </div>
                            <div class="bg-slate-900/50 rounded-xl p-5 border border-slate-700">
                                <h4 class="text-red-400 font-bold mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-triangle-exclamation"></i> é¢¨éšªè­¦ç¤º
                                </h4>
                                <ul class="space-y-3 text-sm text-slate-300">
                                    ${(analysis.bearish_points || []).length > 0
                                        ? (analysis.bearish_points || []).map(point => `<li class="flex items-start gap-2"><i class="fa-solid fa-exclamation text-red-400 mt-1 flex-shrink-0"></i><span>${point}</span></li>`).join('')
                                        : '<li class="text-slate-500">æš«ç„¡é¢¨éšªè­¦ç¤º</li>'
                                    }
                                </ul>
                            </div>
                        </div>
                        
                        <!-- è¡Œæ¥­å°æ¯” -->
                        ${analysis.industry_comparison && analysis.industry_comparison !== 'N/A' ? `
                        <div class="bg-slate-900/50 rounded-xl p-5 border border-slate-700 mb-6">
                            <h4 class="text-blue-400 font-bold mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-building"></i> è¡Œæ¥­å°æ¯”åˆ†æ
                            </h4>
                            <p class="text-slate-300 leading-6 text-sm">${analysis.industry_comparison}</p>
                        </div>
                        ` : ''}
                        
                        <!-- æ½›åœ¨å‚¬åŒ–åŠ‘ -->
                        ${analysis.catalyst && analysis.catalyst !== 'N/A' ? `
                        <div class="bg-slate-900/50 rounded-xl p-5 border border-slate-700 mb-6">
                            <h4 class="text-yellow-400 font-bold mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-bolt"></i> æ½›åœ¨å‚¬åŒ–åŠ‘
                            </h4>
                            <p class="text-slate-300 leading-6 text-sm">${analysis.catalyst}</p>
                        </div>
                        ` : ''}
                        
                        <!-- è©³ç´°åˆ†æ -->
                        <div class="bg-slate-900/30 rounded-xl p-5 border border-slate-700">
                            <h4 class="text-slate-400 text-xs font-bold uppercase mb-3 tracking-wider flex items-center gap-2">
                                <i class="fa-solid fa-file-lines"></i> è©³ç´°å°ˆæ¥­åˆ†æ
                            </h4>
                            <p class="text-slate-300 leading-7 text-sm text-justify whitespace-pre-wrap">${analysis.analysis || 'åˆ†æä¸­...'}</p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-block w-12 h-12 border-4 border-slate-700 border-t-${style.color}-500 rounded-full animate-spin mb-4"></div>
                        <p class="text-slate-400">${style.label} åˆ†æä¸­...</p>
                    </div>
                `;
            }
        }
        
        // --- 4. æ¸²æŸ“ç•«é¢ï¼ˆå–®é¢¨æ ¼ï¼Œä¿ç•™ä»¥å‚™ç”¨ï¼‰ ---
        function renderData(data) {
            document.getElementById('result-area').classList.remove('hidden');
            const m = data.market_data;

            // --- A. å¡«å¯«å¸‚å ´æ•¸æ“š ---
            document.getElementById('stock-name').innerText = m.name;
            
            // æ›´æ–°å·²ä¿å­˜çš„è‚¡ç¥¨åˆ—è¡¨ï¼ˆå¦‚æœå½“å‰è‚¡ç¥¨å·²ä¿å­˜ï¼Œæ›´æ–°åç§°ï¼‰
            updateSavedStockName(m.name);
            // è™•ç†å°æ•¸é»é¡¯ç¤º
            document.getElementById('stock-price').innerText = m.price.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); 
            // å³æ™‚è¡Œæƒ…å€çš„æœ¬ç›Šæ¯”ï¼ˆå‚™ç”¨æ¸²æŸ“å‡½æ•¸ï¼‰
            const stockPeEl2 = document.getElementById('stock-pe');
            if (m.isETF && m.pe === 'ETFä¸é©ç”¨') {
                stockPeEl2.innerHTML = `<i class="fa-solid fa-chart-pie text-xs text-slate-500"></i> <span class="text-slate-400 text-xs">ETF</span>`;
            } else if (m.pe === 'N/A' || !m.pe || m.pe === 'null') {
                stockPeEl2.innerHTML = `<i class="fa-solid fa-chart-pie text-xs text-slate-500"></i> <span class="text-slate-400 text-xs">æœ¬ç›Šæ¯”: æš«ç„¡</span>`;
            } else {
                stockPeEl2.innerHTML = `<i class="fa-solid fa-chart-pie text-xs"></i> <span>æœ¬ç›Šæ¯”: ${m.pe}</span>`;
            }
            
            // å¦‚æœæ˜¯æ¼”ç¤ºæ•¸æ“šï¼Œé¡¯ç¤ºæç¤º
            if (m.isDemo) {
                stockPeEl2.innerHTML = `<span class="text-yellow-500">âš ï¸ æ¼”ç¤ºæ•¸æ“š</span>`;
            }
            
            // å¡«å¯«è²¡å‹™æŒ‡æ¨™ï¼ˆETF é¡¯ç¤ºç‰¹æ®Šæ¨£å¼ï¼ŒN/A é¡¯ç¤ºå‹å–„èªªæ˜ï¼‰
            const peEl2 = document.getElementById('metric-pe');
            const dividendEl2 = document.getElementById('metric-dividend');
            const pbEl2 = document.getElementById('metric-pb');
            const volumeEl2 = document.getElementById('metric-volume');
            
            // æœ¬ç›Šæ¯”
            if (m.pe === 'ETFä¸é©ç”¨') {
                peEl2.innerHTML = `<span class="text-slate-500 text-sm">ETFä¸é©ç”¨</span>`;
            } else if (m.pe === 'N/A' || !m.pe) {
                peEl2.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šè™§æä¸­æˆ–è³‡æ–™æœªå…¬é–‹">æš«ç„¡è³‡æ–™</span>`;
            } else {
                peEl2.innerText = m.pe;
            }
            
            // è‚¡æ¯ç‡
            if (m.dividendYield !== 'N/A' && m.dividendYield) {
                dividendEl2.innerText = `${m.dividendYield}%`;
            } else {
                dividendEl2.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šè¿‘ä¸€å¹´æœªé…æ¯">æœªé…æ¯</span>`;
            }
            
            // è‚¡åƒ¹æ·¨å€¼æ¯”
            if (m.pb === 'ETFä¸é©ç”¨') {
                pbEl2.innerHTML = `<span class="text-slate-500 text-sm">ETFä¸é©ç”¨</span>`;
            } else if (m.pb === 'N/A' || !m.pb) {
                pbEl2.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šè³‡æ–™æœªå…¬é–‹æˆ–è¨ˆç®—ä¸­">æš«ç„¡è³‡æ–™</span>`;
            } else {
                pbEl2.innerText = m.pb;
            }
            
            // æˆäº¤é‡
            if (m.volume > 0) {
                if (m.volume >= 1000000) {
                    volumeEl2.innerText = `${(m.volume / 1000000).toFixed(2)}M`;
                } else if (m.volume >= 1000) {
                    volumeEl2.innerText = `${(m.volume / 1000).toFixed(1)}K`;
                } else {
                    volumeEl2.innerText = m.volume.toLocaleString();
                }
            } else {
                volumeEl2.innerHTML = `<span class="text-slate-500 text-sm" title="å¯èƒ½åŸå› ï¼šä¼‘å¸‚æˆ–åœç‰Œ">ä¼‘å¸‚ä¸­</span>`;
            }
            
            // å¡«å¯«åƒ¹æ ¼å€é–“ï¼ˆN/A æ”¹ç‚ºå‹å–„èªªæ˜ï¼‰
            const formatPrice2 = (value, el, hint) => {
                if (value > 0) {
                    el.innerText = value.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                } else {
                    el.innerHTML = `<span class="text-slate-500 text-sm" title="${hint}">--</span>`;
                }
            };
            
            formatPrice2(m.previousClose, document.getElementById('metric-prev-close'), 'å‰ä¸€äº¤æ˜“æ—¥æ”¶ç›¤åƒ¹');
            formatPrice2(m.dayHigh, document.getElementById('metric-high'), 'ä»Šæ—¥å°šæœªæœ‰æˆäº¤');
            formatPrice2(m.dayLow, document.getElementById('metric-low'), 'ä»Šæ—¥å°šæœªæœ‰æˆäº¤');
            formatPrice2(m.fiftyTwoWeekHigh, document.getElementById('metric-52w-high'), 'è³‡æ–™ä¸è¶³52é€±');
            formatPrice2(m.fiftyTwoWeekLow, document.getElementById('metric-52w-low'), 'è³‡æ–™ä¸è¶³52é€±');

            // è™•ç†æ¼²è·Œé¡è‰² (Yahoo å›å‚³çš„æ˜¯å­—ä¸²å¸¶ %ï¼Œå…ˆåˆ¤æ–·æ­£è² )
            const changeStr = m.change || "0%";
            const isUp = !changeStr.includes('-'); // æ²’è² è™Ÿå°±æ˜¯æ¼²
            const changeEl = document.getElementById('stock-change');
            
            changeEl.innerText = changeStr;
            // å¥—ç”¨å°ç£ç¿’æ…£ï¼šç´…æ¼²ç¶ è·Œ (è‹¥è¦ç¾å¼ï¼Œè«‹äº’æ› class)
            if (isUp) {
                changeEl.className = "text-lg font-bold flex items-center justify-end gap-1 stock-up";
                changeEl.innerHTML += ' <i class="fa-solid fa-caret-up"></i>';
            } else {
                changeEl.className = "text-lg font-bold flex items-center justify-end gap-1 stock-down";
                changeEl.innerHTML += ' <i class="fa-solid fa-caret-down"></i>';
            }

            // --- B. å¡«å¯« AI åˆ†æ ---
            document.getElementById('ai-summary').innerText = data.summary;
            document.getElementById('ai-analysis').innerText = data.analysis;


            // æ¸…å–®
            document.getElementById('bull-list').innerHTML = data.bullish_points.map(p => `<li class="flex gap-2"><i class="fa-solid fa-check text-green-500 mt-1 shrink-0"></i> <span>${p}</span></li>`).join('');
            document.getElementById('bear-list').innerHTML = data.bearish_points.map(p => `<li class="flex gap-2"><i class="fa-solid fa-triangle-exclamation text-red-500 mt-1 shrink-0"></i> <span>${p}</span></li>`).join('');
            
            // --- C. æ¸²æŸ“åœ–è¡¨ ---
            if (data.history && data.history.length > 0) {
                renderCharts(data.history);
            } else {
                // å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                console.log('æ²¡æœ‰å†å²æ•°æ®');
                const priceChartContainer = document.getElementById('price-chart').parentElement;
                const volumeChartContainer = document.getElementById('volume-chart').parentElement;
                
                priceChartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-slate-500"><p>æš«ç„¡æ­·å²æ•¸æ“šï¼Œç„¡æ³•é¡¯ç¤ºæŠ€è¡“ç·šåœ–</p></div>';
                volumeChartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-slate-500"><p>æš«ç„¡æ­·å²æ•¸æ“šï¼Œç„¡æ³•é¡¯ç¤ºäº¤æ˜“é‡åœ–è¡¨</p></div>';
            }
        }
        
        // --- 4. æ¸²æŸ“åœ–è¡¨ ---
        let priceChart = null;
        let volumeChart = null;
        
        function renderCharts(history) {
            console.log('å¼€å§‹æ¸²æŸ“å›¾è¡¨ï¼Œå†å²æ•°æ®:', history);
            
            if (!history || history.length === 0) {
                console.error('å†å²æ•°æ®ä¸ºç©ºï¼Œæ— æ³•æ¸²æŸ“å›¾è¡¨');
                return;
            }
            
            // ç¡®ä¿ result-area å¯è§ï¼Œè¿™æ · canvas å…ƒç´ æ‰èƒ½è¢«è®¿é—®
            const resultArea = document.getElementById('result-area');
            if (resultArea && resultArea.classList.contains('hidden')) {
                resultArea.classList.remove('hidden');
            }
            
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ DOM å·²æ›´æ–°
            requestAnimationFrame(() => {
                // æ£€æŸ¥ canvas å…ƒç´ æ˜¯å¦å­˜åœ¨
                const priceCanvas = document.getElementById('price-chart');
                const volumeCanvas = document.getElementById('volume-chart');
                
                if (!priceCanvas || !volumeCanvas) {
                    console.error('æ‰¾ä¸åˆ° chart canvas å…ƒç´ ï¼Œprice-chart:', !!priceCanvas, 'volume-chart:', !!volumeCanvas);
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå»¶è¿Ÿé‡è¯•
                    setTimeout(() => renderCharts(history), 100);
                    return;
                }
                
                // å‡†å¤‡æ•°æ®
                const labels = history.map(h => {
                    try {
                        // è½¬æ¢æ—¥æœŸæ ¼å¼ï¼š113/12/22 -> 2024/12/22
                        const dateParts = h.date.split('/');
                        if (dateParts.length === 3) {
                            const year = parseInt(dateParts[0]) + 1911; // æ°‘å›½å¹´è½¬è¥¿å…ƒå¹´
                            return `${year}/${dateParts[1]}/${dateParts[2]}`;
                        }
                        return h.date;
                    } catch (e) {
                        console.error('æ—¥æœŸè½¬æ¢å¤±è´¥:', h.date, e);
                        return h.date;
                    }
                });
                
                const closePrices = history.map(h => parseFloat(h.close) || 0);
                const openPrices = history.map(h => parseFloat(h.open) || 0);
                const highPrices = history.map(h => parseFloat(h.high) || 0);
                const lowPrices = history.map(h => parseFloat(h.low) || 0);
                const volumes = history.map(h => parseInt(h.volume) || 0);
                
                console.log('å›¾è¡¨æ•°æ®å‡†å¤‡å®Œæˆ:', {
                    labels: labels.length,
                    closePrices: closePrices.length,
                    volumes: volumes.length
                });
                
                // é”€æ¯æ—§å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (priceChart) {
                    priceChart.destroy();
                    priceChart = null;
                }
                if (volumeChart) {
                    volumeChart.destroy();
                    volumeChart = null;
                }
                
                // åˆ›å»ºä»·æ ¼å›¾è¡¨
                const priceCtx = priceCanvas.getContext('2d');
                priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç›¤åƒ¹',
                            data: closePrices,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'é–‹ç›¤åƒ¹',
                            data: openPrices,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'æœ€é«˜åƒ¹',
                            data: highPrices,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'æœ€ä½åƒ¹',
                            data: lowPrices,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 1,
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#cbd5e1'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    }
                }
                });
                
                // åˆ›å»ºäº¤æ˜“é‡å›¾è¡¨
                const volumeCtx = volumeCanvas.getContext('2d');
                volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'äº¤æ˜“é‡',
                        data: volumes,
                        backgroundColor: volumes.map((v, i) => {
                            // æ ¹æ®æ¶¨è·Œæ˜¾ç¤ºä¸åŒé¢œè‰²
                            const change = history[i].change || 0;
                            return change >= 0 ? 'rgba(239, 68, 68, 0.6)' : 'rgba(34, 197, 94, 0.6)';
                        }),
                        borderColor: volumes.map((v, i) => {
                            const change = history[i].change || 0;
                            return change >= 0 ? 'rgba(239, 68, 68, 1)' : 'rgba(34, 197, 94, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'äº¤æ˜“é‡: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(1) + 'K';
                                    }
                                    return value;
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    }
                }
            });
            });
        }
    </script>
</body>
</html>